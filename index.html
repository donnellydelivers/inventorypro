<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Product Editor v3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        :root { --primary: #007185; --success: #2e7d32; --danger: #d32f2f; --amazon: #ff9900; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f2; padding: 20px; color: #111; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        header { background: #232f3e; color: white; padding: 15px 30px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .global-controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .slider-stack { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        
        .drop-zone { background: #fff; border: 2px dashed #adb5bd; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; }
        
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .image-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        .preview-container { width: 100%; height: 350px; background: #eee; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .preview-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .compare-btn { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 4px 8px; cursor: pointer; }
        
        .control-group { margin-bottom: 8px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 11px; font-weight: bold; color: #555; }
        
        .editor-panel { padding: 15px; background: #fff; }
        .btn-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        
        button { padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; }
        .btn-clean { background: var(--amazon); color: #111; }
        .btn-bg { background: var(--primary); color: white; }
        .btn-zip { background: #333; color: white; padding: 12px 25px; font-size: 14px; }
        .status-tag { position: absolute; top: 10px; right: 10px; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; color: white; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>Pro Product Editor (Amazon Optimized)</h2>
        <div>
            <button onclick="document.getElementById('apiModal').classList.add('active')" style="background:#444; color:white;">Settings</button>
            <span id="stats" style="margin-left:15px;">0 Photos</span>
        </div>
    </header>

    <div class="global-controls">
        <div>
            <h4 style="margin-bottom:10px;">Batch Actions</h4>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-clean" onclick="batchClean()">ðŸ§¼ One-Click Clean All</button>
                <button class="btn-bg" onclick="batchProcessAI('2.0')">Remove All BG (v2.0)</button>
                <button class="btn-zip" onclick="downloadAll()">Download ZIP (2000px White BG)</button>
            </div>
        </div>
        <div class="slider-stack">
            <div class="control-group"><label>Batch Straighten</label><input type="range" id="g-rot" min="-15" max="15" step="0.1" value="0" oninput="syncAll('rot', this.value)"></div>
            <div class="control-group"><label>Batch Lighting</label><input type="range" id="g-bri" min="80" max="150" value="100" oninput="syncAll('bri', this.value)"></div>
            <div class="control-group"><label>Batch Saturation</label><input type="range" id="g-sat" min="100" max="180" value="100" oninput="syncAll('sat', this.value)"></div>
            <div class="control-group"><label>Batch Shadow</label><input type="range" id="g-shd" min="0" max="30" value="0" oninput="syncAll('shd', this.value)"></div>
        </div>
    </div>

    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <h3>Drag & Drop Product Photos</h3>
        <p>Supports RAW-derived JPEGs and PNGs</p>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles(this.files)" style="display:none">
    </div>

    <div class="image-grid" id="imageGrid"></div>
</div>

<div class="modal" id="apiModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px; border-radius:8px; width:400px;">
        <h3>Hugging Face Token</h3>
        <input type="password" id="apiKeyInput" placeholder="hf_..." style="width:100%; padding:10px; margin:20px 0;">
        <button class="btn-bg" style="width:100%;" onclick="saveKey()">Save & Continue</button>
    </div>
</div>

<script>
    let images = [];
    let apiKey = localStorage.getItem('huggingface_api_token') || '';

    function saveKey() {
        apiKey = document.getElementById('apiKeyInput').value;
        localStorage.setItem('huggingface_api_token', apiKey);
        document.getElementById('apiModal').style.display = 'none';
    }

    async function handleFiles(files) {
        for (const file of Array.from(files)) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = { 
                    id: 'img_' + Math.random().toString(36).substr(2, 9), 
                    name: file.name, 
                    original: e.target.result, 
                    processed: null,
                    isComparing: false
                };
                images.push(img);
                renderCard(img);
            };
            reader.readAsDataURL(file);
        }
        document.getElementById('stats').textContent = images.length + ' Photos';
    }

    function renderCard(img) {
        const grid = document.getElementById('imageGrid');
        const card = document.createElement('div');
        card.className = 'image-card';
        card.id = img.id;
        card.innerHTML = `
            <div class="preview-container">
                <div class="status-tag" id="stat-${img.id}" style="background:#666">Original</div>
                <img id="view-${img.id}" src="${img.original}">
                <div class="compare-btn" onmousedown="toggleView('${img.id}', true)" onmouseup="toggleView('${img.id}', false)">Hold to see Original</div>
            </div>
            <div class="editor-panel">
                <div class="control-group"><label>Straighten <span id="v-rot-${img.id}">0Â°</span></label><input type="range" id="rot-${img.id}" min="-15" max="15" step="0.1" value="0" oninput="applyFilters('${img.id}')"></div>
                <div class="control-group"><label>Light/Sat/Shadow</label>
                    <div style="display:flex; gap:5px;">
                        <input type="range" id="bri-${img.id}" min="80" max="150" value="100" oninput="applyFilters('${img.id}')">
                        <input type="range" id="sat-${img.id}" min="100" max="180" value="100" oninput="applyFilters('${img.id}')">
                        <input type="range" id="shd-${img.id}" min="0" max="30" value="0" oninput="applyFilters('${img.id}')">
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn-clean" onclick="cleanPhoto('${img.id}')">ðŸ§¼ Clean</button>
                    <button class="btn-bg" onclick="processAI('${img.id}', '2.0')">BG Fix</button>
                    <button style="background:#eee" onclick="revert('${img.id}')">Revert</button>
                </div>
            </div>
        `;
        grid.appendChild(card);
    }

    function toggleView(id, showOriginal) {
        const imgObj = images.find(i => i.id === id);
        const view = document.getElementById(`view-${id}`);
        view.src = showOriginal ? imgObj.original : (imgObj.processed || imgObj.original);
    }

    async function cleanPhoto(id) {
        const imgObj = images.find(i => i.id === id);
        // Normalize: Boost light slightly, Saturation to 115%, Shadow lift to 10px
        document.getElementById(`bri-${id}`).value = 110;
        document.getElementById(`sat-${id}`).value = 120;
        document.getElementById(`shd-${id}`).value = 8;
        applyFilters(id);
    }

    function syncAll(type, val) {
        images.forEach(img => {
            document.getElementById(`${type}-${img.id}`).value = val;
            applyFilters(img.id);
        });
    }

    async function applyFilters(id) {
        const imgObj = images.find(i => i.id === id);
        const rot = document.getElementById(`rot-${id}`).value;
        const bri = document.getElementById(`bri-${id}`).value;
        const sat = document.getElementById(`sat-${id}`).value;
        const shd = document.getElementById(`shd-${id}`).value;

        document.getElementById(`v-rot-${id}`).textContent = rot + 'Â°';

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const tempImg = new Image();
        
        tempImg.onload = () => {
            canvas.width = tempImg.width;
            canvas.height = tempImg.height;
            ctx.filter = `brightness(${bri}%) saturate(${sat}%) drop-shadow(0 ${shd}px ${shd}px rgba(0,0,0,0.3))`;
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.rotate(rot * Math.PI / 180);
            ctx.drawImage(tempImg, -tempImg.width/2, -tempImg.height/2);
            document.getElementById(`view-${id}`).src = canvas.toDataURL();
        };
        tempImg.src = imgObj.processed || imgObj.original;
    }

    async function processAI(id, version, retryCount = 0) {
        if(!apiKey) return document.getElementById('apiModal').style.display = 'flex';
        
        const imgObj = images.find(i => i.id === id);
        const model = version === '2.0' ? 'briaai/RMBG-2.0' : 'briaai/RMBG-1.4';
        const stat = document.getElementById(`stat-${id}`);
        stat.textContent = 'Removing BG...';
        stat.style.background = '#ff9900';

        try {
            const imageBlob = await (await fetch(imgObj.original)).blob();
            // Use puter.net.fetch to bypass CORS
            const response = await puter.net.fetch(`https://api-inference.huggingface.co/models/${model}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/octet-stream' },
                body: imageBlob
            });

            if (response.status === 503 && retryCount < 3) {
                await new Promise(r => setTimeout(r, 5000));
                return processAI(id, version, retryCount + 1);
            }

            const blob = await response.blob();
            const reader = new FileReader();
            reader.onloadend = () => {
                imgObj.processed = reader.result;
                stat.textContent = 'Transparent';
                stat.style.background = '#2e7d32';
                applyFilters(id); // Re-apply current rotation/light to the new BG-less image
            };
            reader.readAsDataURL(blob);
        } catch (e) {
            stat.textContent = 'API Error';
            stat.style.background = 'red';
        }
    }

    async function downloadAll() {
        const zip = new JSZip();
        for(let img of images) {
            const finalCanvas = document.createElement('canvas');
            const size = 2000; // Amazon Recommended Size
            finalCanvas.width = size;
            finalCanvas.height = size;
            const fctx = finalCanvas.getContext('2d');
            
            // White Background for Amazon Safety
            fctx.fillStyle = "white";
            fctx.fillRect(0,0,size,size);
            
            const currentImg = new Image();
            currentImg.src = document.getElementById(`view-${img.id}`).src;
            await new Promise(r => currentImg.onload = r);
            
            // Calculate "Auto-Crop" fit (contain within 85% of canvas for Amazon compliance)
            const scale = Math.min((size*0.85)/currentImg.width, (size*0.85)/currentImg.height);
            const w = currentImg.width * scale;
            const h = currentImg.height * scale;
            fctx.drawImage(currentImg, (size-w)/2, (size-h)/2, w, h);
            
            const dataUrl = finalCanvas.toDataURL('image/jpeg', 0.9);
            zip.file(img.name.split('.')[0] + "-main.jpg", dataUrl.split(',')[1], {base64: true});
        }
        zip.generateAsync({type:"blob"}).then(c => {
            const l = document.createElement('a');
            l.href = URL.createObjectURL(c);
            l.download = "amazon_ready_batch.zip";
            l.click();
        });
    }

    function batchClean() { images.forEach(i => cleanPhoto(i.id)); }
    function batchProcessAI(v) { images.forEach(i => processAI(i.id, v)); }
    function revert(id) {
        const imgObj = images.find(i => i.id === id);
        imgObj.processed = null;
        document.getElementById(`view-${id}`).src = imgObj.original;
        document.getElementById(`stat-${id}`).textContent = 'Original';
        document.getElementById(`stat-${id}`).style.background = '#666';
    }
</script>

</body>
</html>